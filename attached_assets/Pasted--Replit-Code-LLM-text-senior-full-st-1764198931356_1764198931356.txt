Вот супер-промт, который можно сразу отдавать в Replit / Code LLM.

---

```text
Ты — senior full-stack разработчик KETMAR Market (Telegram MiniApp + web).  
Нужно развить **кабинет магазина** до уровня PRO-аналитики (аналог Avito Pro) + учесть сезонные ярмарки (тюльпаны, Новый год и т.д.).

Текущий контекст:
- Есть сущность Store (кабинет магазина) с базовой статистикой (totalAds, activeAds, views, contactClicks).
- Есть фермерский кабинет с продвинутой аналитикой (сезонность, спрос по радиусу, тюльпаны и т.п.).
- Есть сезонные сценарии: тюльпаны на 8 марта, новогодняя ярмарка, осенняя ярмарка и прочие «ярмарки».

ЗАДАЧА: 
1) Прокачать кабинет магазина до **Store PRO-Analytics**: графики, кликабельные гистограммы, таблицы эффективности.  
2) Синхронизировать логику с фермерским кабинетом (похожие метрики).  
3) Перенести часть сезонных сценариев (тюльпаны, новогодняя ярмарка и круглогодичные ярмарки) из «фермерской зоны» в контекст магазина.  
4) Оставить за фермерским кабинетом только «осеннюю ярмарку» и чисто фермерские сценарии.

---

## 1. Модель событий и агрегатов для аналитики

### 1.1. Ввести сущность событий по объявлениям магазина

Создай Mongo-модель `AdEvent` (если аналогичной ещё нет):

- `adId: ObjectId` — объявление
- `storeId: ObjectId` — магазин
- `userId?: ObjectId` — кто совершил действие (если авторизован)
- `type: "view" | "favorite" | "contact_click" | "open_telegram" | "call_click" | "order_start" | "order_finish"`
- `source: "organic" | "boost" | "banner" | "campaign"` — канал (по умолчанию "organic")
- `createdAt: Date`
- `geo?: { type: "Point", coordinates: [lng, lat] }` — опционально, если есть гео пользователя
- `categoryId?: ObjectId`

Подключи 2dsphere-индекс по geo, если ещё не включали.

Все места фронта, где:
- показывается карточка товара,
- нажимается «показать телефон»,
- нажимается «написать в Telegram»,
- стартует оформление заказа (если есть),
ДОЛЖНЫ отправлять POST на `/api/analytics/ad-event` с нужным типом.

Сделай простой endpoint:
`POST /api/analytics/ad-event`
Body: `{ adId, type, source?, geo? }`
Внутри:
- подставь `storeId` из объявления,
- подставь категорию объявления,
- сохрани событие.

### 1.2. Агрегированные дневные метрики магазина

Сделай агрегационный слой (либо on-the-fly, либо CRON, опиши в коде):

Модель `StoreDailyStats`:

- `storeId: ObjectId`
- `date: Date` (UTC без времени, начало дня)
- `views: number`
- `favorites: number`
- `contactClicks: number`
- `telegramOpens: number`
- `callClicks: number`
- `ordersStarted: number`
- `ordersFinished: number`

Индексы:
- `{ storeId: 1, date: 1 }` (unique)

Сделай сервис/агрегацию, который по `AdEvent` агрегирует в `StoreDailyStats` за период (последние 90 дней).  
На первом этапе можно считать on-the-fly через `$group` без записи в коллекцию, но лучше сразу предусмотреть функцию `rebuildStoreStats(storeId, fromDate, toDate)`.

---

## 2. Backend API: PRO-аналитика магазина

Создай router `/api/store/pro-analytics`.

Нужны следующие эндпоинты (все требуют авторизацию и проверку, что currentUser — владелец магазина):

### 2.1. Общий обзор

`GET /api/store/pro-analytics/overview?period=7d|30d|90d`

Возвращает:

- `periodStart`, `periodEnd`
- `totalViews`
- `totalContactClicks`
- `totalFavorites`
- `ctrContacts` (contactClicks / views, с защитой от деления на 0)
- `topAdsByViews` (до 5 шт: id, title, views, contactClicks, favorites)
- `topCategoriesByViews` (до 5 шт: categoryName, views, contactClicks)
- `geoRadiusBest` — радиус, на котором было больше всего contactClicks (если есть geo).

Данные бери либо из `StoreDailyStats` (агрегируя), либо напрямую из `AdEvent`.

### 2.2. Гистограмма по дням

`GET /api/store/pro-analytics/daily?metric=views|contactClicks|favorites&period=30d`

Ответ:
- массив `{ date: "2025-11-01", value: number }`
- totalValue за период

Эти данные нужны для **кликабельной гистограммы** на фронте.

### 2.3. Таблица эффективности объявлений

`GET /api/store/pro-analytics/ads?period=30d&sort=views|contactClicks|ctr`

Возвращает массив:

- `adId`
- `title`
- `status`
- `views`
- `favorites`
- `contactClicks`
- `telegramOpens`
- `callClicks`
- `ctrContacts` (contactClicks / views)

Сортировка по параметру `sort`.

### 2.4. Сезонная аналитика для магазина (почти как у фермеров)

`GET /api/store/pro-analytics/seasonal?period=365d`

Возвращает:

- `byMonth` — 12 точек `{ month: 1..12, views, contactClicks, ordersFinished }`
- `bestMonths` — массив 3 лучших месяцев по contactClicks
- `byCategory` — разбивка по категориям магазина: `{ categoryName, views, contactClicks, avgPrice? }`

Это нужно, чтобы магазины видели «в какие месяцы что лучше продаётся» по аналогии с фермерским кабинетом.

---

## 3. Frontend: PRO-вкладка в кабинете магазина

В существующем Store-кабинете:

1. Добавь ещё одну вкладку: **«PRO-аналитика»** (рядом со «Статистика» или вместо базовой статистики, а базовую статистику можно включить в начало PRO).

### 3.1. Блок «Обзор»

Сделай сверху панели-карточки:

- `Просмотры за период`
- `Клики по контактам`
- `В избранное`
- `CTR контактов`

Рядом селектор периода: `7 дней / 30 дней / 90 дней`.  
При смене периода — перезапрос `GET /overview` и `GET /daily`.

### 3.2. Кликабельная гистограмма

Отобрази гистограмму (bar chart) по дням:

- по умолчанию метрика `views`.
- сверху табы: `Просмотры`, `Клики по контактам`, `Избранное`.
  При переключении — запрос соответствующего `metric` у `/daily`.

**Кликабельность:**
- При тапе по столбцу дня:
  - снизу открывается слайд-панель «Подробно за <дата>»:
    - `views / favorites / contactClicks`
    - ТОП-3 объявления за этот день.
  - данные можно запросить доп. эндпоинтом:
    `GET /api/store/pro-analytics/daily-detail?date=YYYY-MM-DD`.

### 3.3. Таблица объявлений

Ниже — таблица/список «Эффективность объявлений»:

- Столбцы: Фото, Название, Просмотры, В избранное, Клики по контактам, CTR.
- Клики по заголовку → переход к объявлению.
- Переключатель sort в UI:
  - «По просмотрам»
  - «По кликам»
  - «По CTR»
  → меняешь `sort` в запросе `/ads`.

### 3.4. Мини-блок «Сезонность»

В нижней части вкладки:

- маленький график по месяцам (можно line chart или упрощённый bar chart).
- текст:  
  - «Лучшие месяцы: март, июнь, декабрь» (берём из `bestMonths`).
- список категорий:
  - `Категория — просмотры / клики по контактам`.

---

## 4. Сезонные сценарии: перенос тюльпанов и новогодней ярмарки в магазины

Сейчас часть логики «тюльпаны/ярмарки» завязана на фермерском кабинете.  
Нужно:

1. Ввести сущность `Campaign` (или `SeasonFair`), если её ещё нет:

Поля:
- `code: "march8_tulips" | "newyear_fair" | "autumn_fair" | ...`
- `title: string`
- `type: "store" | "farmer"`
- `startDate?: Date`
- `endDate?: Date`
- `isActive: boolean`

2. Изменить бизнес-правила:

- **Тюльпаны (8 марта)**:  
  - `code = "march8_tulips"`, `type = "store"`.  
  - Все объявления в этой кампании должны быть привязаны к магазину (`storeId` обязателен).  
  - Формы подачи тюльпанов и витрина тюльпанов должны использовать Store-флоу и PRO-аналитику магазина.

- **Новогодняя ярмарка**:  
  - `code = "newyear_fair"`, `type = "store"`.  
  - Товары этой ярмарки — тоже магазинные (витрины магазинов, пекарни, подарочные наборы и т.д.).

- **Осенняя ярмарка**:  
  - `code = "autumn_fair"`, `type = "farmer"`.  
  - Остаётся в фермерском кабинете (только фермеры + фермерская аналитика).

- **Все остальные круглогодичные ярмарки / спец-ленты**:  
  - по умолчанию `type = "store"` (магазинные кампании).

3. На уровне модели `Ad`:

- добавить (или использовать) поле `campaignCode?: string`.
- при подаче объявления через тюльпанную или новогоднюю ярмарку:
  - обязательно указывать `storeId` + `campaignCode`.
- все аналитические события `AdEvent` для таких объявлений участвуют как:
  - в обычной магазинной аналитике,
  - и в аналитике кампаний (на будущее можно сделать `/api/store/pro-analytics/campaigns`).

---

## 5. Синхронизация с фермерским кабинетом

Важно: фермерский кабинет уже умеет показывать сезонность, спрос по радиусу и т.д.  
Для магазина:

- Используй **те же сервисы агрегации**, где это возможно:
  - например, общий сервис `buildSeasonalStats({ storeId? , farmerId? })`.
- В коде не дублируй вычисления; выдели общий модуль для:
  - агрегации по месяцам,
  - агрегации по категориям,
  - расчёта CTR.

---

## 6. Общие требования

- Backend: TypeScript, чистые сервисы, не смешивай бизнес-логику с Express-хендлерами.
- Frontend: React, аккуратные хуки для запросов (`useStoreProAnalytics(period)` и т.п.).
- Не ломай текущий минимальный кабинет магазина — все новые фичи должны быть **дополнением**, а не заменой.

Цель:  
Сделать **PRO-кабинет магазина** с:
- кликабельными гистограммами,
- таблицей эффективности объявлений,
- сезонной аналитикой,
- понятной интеграцией сезонных кампаний (тюльпаны, Новый год и т.д.),  
при этом сохранить связь с уже существующей аналитикой фермеров (осенняя ярмарка остаётся фермерской).
```

Если захочешь потом — отдельно сделаем промт чисто под **аналитику кампаний (march8/newyear)** или под **витрину магазина с фильтром «только тюльпаны / только новогодние подарки»**.
