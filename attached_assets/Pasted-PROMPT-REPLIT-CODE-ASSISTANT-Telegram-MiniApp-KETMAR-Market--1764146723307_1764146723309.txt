PROMPT ДЛЯ REPLIT / CODE ASSISTANT

Нужно найти и исправить баг в Telegram MiniApp KETMAR Market и слегка поменять UX формы добавления объявления.

1. Контекст проекта

MiniApp (frontend): React / Vite (TypeScript), открывается как Telegram WebApp.

Backend: Node.js + Express + MongoDB.

Всё развёрнуто на Replit, MiniApp открывается по публичному URL Replit.

Во вкладке «Добавить объявление» (или аналогичной add-ad / add-listing) при открытии мини-приложения Telegram:

MiniApp пытается определить геолокацию пользователя (3 секунды «думает»).

После этого всё приложение падает, и Telegram показывает Replit-страницу «Hmm… We couldn't reach this app. Make sure this app has a port open and is ready to receive HTTP traffic».

Нужно:

Выяснить причину падения (скорее всего, неправильный запрос к API/порту или необработанная ошибка геолокации), исправить и стабилизировать MiniApp.

Упростить форму добавления объявления: убрать карту на шаге размещения объявления, оставить только город и район текстом/полями.

2. Диагностика и исправление ошибки

Сделай пошагово:

Запусти проект на Replit
Убедись, что:

backend-сервер Express слушает process.env.PORT || 3000;

именно этот порт пробрасывается в Replit как Web-порт;

MiniApp открывается по тому же домену/порту (нет жёстко захардкоженных localhost:3000 и т.п. в production-сборке).

Воспроизведи баг

Открой MiniApp в браузере (через public URL Replit или встроенный WebView).

Перейди во вкладку «Добавить объявление».

Дай разрешение на геолокацию, подожди ~3 секунды.

Отследи, что в этот момент происходит:

Открой DevTools → вкладка Console и Network.

Посмотри, какой запрос уходит (например /api/location/reverse, /api/geo/detect, /api/ads/new и т.п.) и какой статус/ошибка возвращается.

Проверь backend-логи

Посмотри лог Replit (консоль) во время воспроизведения ошибки.

Найди stack trace / unhandled rejection / crash Node-процесса.

Исправь причину:

если порт не тот — выровняй с process.env.PORT;

если падает из-за fetch/axios к неправильному URL — замени на относительный путь (например, /api/... вместо полного Replit URL) и/или поправь baseURL;

если падает из-за отсутствия переменной окружения (API-ключ геокодера, BASE_URL и т.п.) — добавь проверки и дефолтные значения.

Обработай ошибки геолокации на фронте
Найди компонент, который отвечает за вкладку Добавить объявление. Это может быть один из файлов, например:

src/pages/AddAd.tsx

src/pages/AddListing.tsx

src/features/ad/AddAdForm.tsx

или похожие.

В нём:

Найди логику, где запрашивается местоположение (navigator.geolocation.getCurrentPosition, getCurrentPosition, кастомный useGeolocation и т.п.).

Добавь обработку всех ошибок и таймаутов:

navigator.geolocation.getCurrentPosition(
  (pos) => { /* успех */ },
  (err) => {
    console.error('Geo error', err);
    // Поставь флаг, что гео недоступно, и покажи юзеру текст:
    // "Не удалось определить местоположение, укажите город и район вручную"
  },
  { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
);


Убедись, что при ошибке геолокации приложение не делает никакого redirect на внешний URL Replit и не закрывает WebApp. Должно просто остаться на форме.

Проверка после фикса

Ещё раз пройди сценарий «Добавить объявление» в MiniApp.

Приложение не должно падать, не должна появляться страница Replit об ошибке.

При неудачной геолокации пользователь просто видит сообщение и может вручную выбрать/ввести город и район.

3. Убрать карту при размещении объявления

Задача: в форме добавления объявления не показывать карту, но оставить логику города/района.

Сделай:

В компоненте формы (тот же AddAd / AddListing):

Найди компонент карты, например:

<Map />, <LocationMap />, <YandexMap />, <GeoMap /> или аналогичный.

Полностью убери его рендер на странице добавления объявления:

либо удалив JSX-блок с картой;

либо закрыв его условием:

{false && <MapComponent ... />}


(лучше — удалить импорт и сам JSX).

Вместо карты отобрази текст и/или поля ввода:

Поля Город и Район:

<div className="location-block">
  <label>
    Город
    <input
      type="text"
      value={city}
      onChange={(e) => setCity(e.target.value)}
      placeholder="Например: Брест"
    />
  </label>

  <label>
    Район
    <input
      type="text"
      value={district}
      onChange={(e) => setDistrict(e.target.value)}
      placeholder="Например: Московский район"
    />
  </label>
</div>


Если есть успешное определение геолокации и/или reverse-geocoding, можно авто-заполнить эти поля, но без визуальной карты.

Убедись, что:

backend по-прежнему получает координаты (если они есть) и сохраняет GeoJSON/адрес, как раньше;

в базу обязательно попадает текстовый city и district (используется при отображении объявления, как «Город + район»);

другие части приложения (карта при просмотре объявлений, вкладка «на карте», геопоиск “рядом со мной”) не ломаются — карту убираем только из формы добавления.

4. Итог

В итоге нужно:

Исправить ошибку, из-за которой MiniApp после попытки определить геолокацию уходит на Replit-страницу «Hmm… We couldn't reach this app» (настроить порт, baseURL, обработку ошибок, убрать любые redirect/краши).

Во вкладке добавления объявления отключить отрисовку карты и оставить только:

текст/поля Город и Район,

опциональное автозаполнение из геолокации, но без карты.

Сделай необходимые правки во фронтенде и бэкенде, прокомментируй ключевые изменения в коде.