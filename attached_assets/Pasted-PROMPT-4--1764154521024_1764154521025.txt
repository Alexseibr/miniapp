PROMPT 4 — Авто-подсказки для фермеров («сегодня выгодно продавать картошку»)
Нужно реализовать БЭКЕНД-ЛОГИКУ "подсказок фермеру":
– Анализировать спрос/поиск по продуктам фермерского рынка,
– Понимать, что в районе вырос интерес к определённому товару (картошка, малина, яйца и т.п.),
– Отправлять фермерам подсказки вида:
  «В вашем районе ищут картошку — разместите объявление».

РЕАЛИЗУЕМ ТОЛЬКО backend:
– сервис аналитики,
– хранение аггрегатов,
– генерация рекомендаций для фермеров.
(Отправка пушей/бота можно оформить как вызов обработчика/хелпера.)

========================================
1. ЛОГИРОВАТЬ ПОИСКОВЫЕ ЗАПРОСЫ ПО ФЕРМЕРКЕ
========================================

Создай коллекцию/таблицу SearchLog:

- id
- userId/telegramId (опционально)
- queryText
- normalizedTokens[]   // ['картошка', 'куплю']
- location { lat, lng, regionId }
- createdAt

Нас интересуют запросы по еде/фермерским товарам.

Сделай словарь ключевых слов:
– картошка, морковь, свекла, лук, капуста, яблоки, груши, клубника, малина, черника, смородина, мёд, яйца, молоко, творог, сыр, зелень, выпечка, хлеб, пироги и т.п.

При поиске:
– если запрос содержит фермерские ключевые слова → логируем в SearchLog.

========================================
2. АГРЕГАЦИЯ СПРОСА ПО РАЙОНУ
========================================

Создай периодический job (cron/worker) раз в 30–60 мин:

1) Группируем SearchLog по:
   - regionId (или округление по координатам),
   - normalizedProduct (картошка, малина, мёд и т.д.),
   - период (последние 24 часа / 7 дней).

2) Считаем:
   - countSearches24h,
   - countSearches7d,
   - тренд (рост/падение по сравнению с предыдущими 7 днями).

Результат сохраняем в таблицу FarmerDemand:

- id
- regionId
- productKey (картошка, малина, яйца…)
- searches24h
- searches7d
- trend (up/down/flat)
- updatedAt

========================================
3. НАХОДИТЬ АКТУАЛЬНЫХ ФЕРМЕРОВ В РАЙОНЕ
========================================

Фермер — это продавец, у которого:

– либо есть активные объявления в категории "Фермерский рынок" в этом регионе,
– либо он указал себя как фермер в профиле (farmer=true),
– либо исторически продавал фермерские товары (Ad.category=фермерский рынок).

Нужен сервис:
getFarmersInRegion(regionId) → список farmerUserIds/telegramIds.

========================================
4. ГЕНЕРАЦИЯ ПОДСКАЗОК
========================================

Создай таблицу FarmerSuggestion:

- id
- farmerId
- regionId
- productKey
- message
- status: 'pending' | 'sent' | 'clicked'
- createdAt
- sentAt (опционально)

Cron job (раз в 1 час):

для каждой записи FarmerDemand, где:
– searches24h > некого порога (например, 5–10 запросов),
– trend = 'up'

делает:

1) Находим всех фермеров в этом регионе.
2) Для каждого проверяем, не было ли подсказки по этому productKey за последние N дней.
3) Создаём FarmerSuggestion со следующим текстом:

Примеры сообщений:
– «В вашем районе вырос спрос на картошку. Разместите объявление и продайте быстрее.»
– «Пользователи рядом ищут малину. Если у вас есть ягоды — самое время их выставить.»
– «В радиусе 3 км люди ищут яйца/молоко. Добавьте объявление в раздел "Фермерский рынок".»

========================================
5. ИНТЕГРАЦИЯ С PUSH / TELEGRAM-БОТОМ
========================================

Сделай хелпер:

sendFarmerSuggestion(farmer, suggestion) → void

Пока можно сделать заглушку, но интерфейс должен:

– получать Telegram id или способ связаться,
– отправлять текст сообщения.

Обновлять status в FarmerSuggestion:
– при успешной отправке → 'sent'.

========================================
6. API ДЛЯ АДМИНКИ (ОПЦИОНАЛЬНО)
========================================

Сделай endpoint только если это просто:

GET /api/farmer-suggestions
– фильтры: regionId, productKey, status
– для просмотра, что советуем фермерам.

========================================
7. ТРЕБОВАНИЯ К БЕЗОПАСНОСТИ И ПРОИЗВОДИТЕЛЬНОСТИ
========================================

– Все cron/job аккуратно ограничить по количеству записей (batch).
– Добавить индексы по:
  - SearchLog.regionId + createdAt,
  - FarmerDemand.regionId + productKey,
  - FarmerSuggestion.farmerId + productKey.

ИТОГ:
– Мы логируем спрос на фермерские товары,
– Вычисляем рост интереса по продуктам,
– И фермерам в этом регионе автоматически прилетают подсказки вроде:
  «Сегодня выгодно продавать картошку / малину / яйца», если реально есть спрос.

Реализуй описанную схему на backend, без изменений в существующих публичных API для обычных пользователей.