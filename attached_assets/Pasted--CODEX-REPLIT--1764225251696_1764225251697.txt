ПРОМТ ДЛЯ CODEX / REPLIT

(просто вставь целиком)

Нужно провести безопасный аудит и исправление показа фотографий в ленте мобильного приложения Ketmar Market.

1. ЦЕЛЬ
Фотографии не отображаются в ленте: бесконечный лоадер, пустые превью. Нужно:
– найти причину,
– исправить загрузку,
– оптимизировать изображения,
– убрать дубли запросов,
– добавить fallback,
– ничего не сломать в остальной логике.

2. ПРОВЕРЬ:

2.1. FRONTEND (MiniApp / Mobile Web)
- компонент карточки объявления (AdCard, FeedCard, ListingItem)
- проверь, правильно ли берутся поля: images[0], previewUrl, optimizedUrl
- убедись, что не используется старое поле (например, "photo" или "image")
- убери двойные fetch-и (дублирующиеся useEffect или двойной вызов API)
- добавь fallback-логику:
  если основная картинка не загрузилась → подставить optimized/small версию

2.2. BACKEND
- проверь генерацию preview-версий при загрузке фото
- проверь, что при выдаче в списке возвращается только уменьшенная версия, например:
  { id, title, price, previewImage, location, ... }
- Убедись, что список не возвращает оригиналы 3–8 МБ
- Посмотри, нет ли лишних маршрутов /uploads/*, которые дублируют запросы

2.3. CLOUD STORAGE / CDN
- проверь, что ссылки валидные и доступны без авторизации
- проверь, что URL не содержит localhost или 127.0.0.1
- исправь, если MiniApp тянет фото через неправильный домен

3. ДОБАВЬ ОПТИМИЗАЦИЮ ФОТО (ОЧЕНЬ ВАЖНО)
- При загрузке делать автоматическую генерацию:
  • preview (300px, 40–60KB)
  • feedSmall (600px, 80–120KB)
  • original (без изменений)
- Использовать sharp для Node.js
- Все старые фото прогнать автоматически:
  создай скрипт /scripts/rebuild_images.js
  который проходит по Ads коллекции, скачивает оригинал, генерирует preview и small версии.

4. УБРАТЬ ДУБЛИ ЗАПРОСОВ
Найди, где в ленте:
- API /ads/list вызывается дважды
- getImageUrl вызывается дважды
- есть повторные useEffect, которые срабатывают при каждом рендере
Оставь только 1 запрос.

5. СДЕЛАТЬ ПЛАВНЫЕ PLACEHOLDER’Ы
- В карточке объявления добавить skeleton-лоадер
- Пока фото грузится → показывать blurred preview

6. ФИНАЛЬНАЯ ПРОВЕРКА
После всех изменений проверить:
- изображения отображаются в ленте всегда
- загрузка мгновенная (<1 сек)
- вес карточки не превышает 150KB
- нет ни одного 404/500/timeout при загрузке фото
- ничего не сломано в логике создания объявлений
