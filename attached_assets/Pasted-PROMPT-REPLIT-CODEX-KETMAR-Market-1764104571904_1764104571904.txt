PROMPT ДЛЯ REPLIT / CODEX  
Задача: создать полноценный модуль **Гео-Умной Карты** для KETMAR Market:

- heatmap спроса,
- heatmap предложений,
- радиус поиска,
- геозоны,
- динамическая лента от карты,
- абсолютная интеграция с AI-слоем,
- анализ поисковых запросов,
- всплески спроса в районах,
- рекомендации, где можно продавать.

Работать поверх текущего монорепо (backend + miniapp + admin + bot).

====================================================================
0. ЦЕЛЬ МОДУЛЯ
====================================================================

Создать новый модуль:

`/backend/src/geo-intelligence`  
`/miniapp/src/geo-map`  
`/admin/src/geo-dashboard`

Он должен обеспечивать:

1) Heatmap спроса  
2) Heatmap предложений  
3) Heatmap сезонности (ягоды/овощи/выпечка/цветы)  
4) Динамическую карту объявлений вокруг пользователя  
5) Радиус-кольцо (1 / 3 / 5 / 10 / 20 км)  
6) Гео-подсказки «что ищут рядом»  
7) Гео-подсказки продавцу: «в вашем районе есть спрос на ___»  
8) Гео-подсказки покупателю: «появилось новое объявление рядом»  

Это ключевая фича маркетплейса.

====================================================================
1. BACKEND — ГЕО-INTELLIGENCE ENGINE
====================================================================

Создать модуль:

`/backend/src/geo-intelligence/GeoEngine.ts`

Функции:

```ts
interface GeoEngine {
  getHeatmapDemand(input: { lat: number; lng: number; radiusKm: number }): Promise<GeoPoint[]>;
  getHeatmapSupply(input: { lat: number; lng: number; radiusKm: number }): Promise<GeoPoint[]>;
  getTrendingSearches(input: { lat: number; lng: number; radiusKm: number }): Promise<SearchTrend[]>;
  getTrendingSupply(input: { lat: number; lng: number; radiusKm: number }): Promise<SupplyTrend[]>;
  getGeoFeed(input: { lat: number; lng: number; radiusKm: number; filters?: any }): Promise<Ad[]>;
  getDemandForCategory(input: { categoryId: string; lat: number; lng: number }): Promise<any>;
}
Где:

Heatmap спроса — точки, где пользователи ищут товары.
Источники:

поисковые запросы,

клики по товарам,

открытие категории,

избранное,

пустые выдачи («выпечка — ничего не найдено»).

Heatmap предложений — точки объявлений:

2dsphere точки объявлений,

сгруппированные по ячейкам (cluster).

TrendingSearches — популярные запросы по гео:

«ягоды»,

«выпечка»,

«кровати»,

«квартиры».

TrendingSupply — всплеск новых объявлений:

8 новых объявлений «клубника» в Гершонах → отображаем на карте.

GeoFeed — та же лента, но завязанная на карту.

====================================================================
2. BACKEND — GEO-CLUSTERING
Сделать кластеризацию для карты:

Алгоритм:

взять все точки объявлений в радиусе,

разделить на сетку (ячейки 100–200 метров),

в каждой ячейке:

count объявлений,

средняя цена,

доминирующая категория.

Сохранить API:

http
Копировать код
GET /api/geo/heatmap/supply?lat=...&lng=...&radius=...
GET /api/geo/heatmap/demand?lat=...&lng=...&radius=...
GET /api/geo/feed?lat=...&lng=...&radius=...
GET /api/geo/trending-searches?lat=...&lng=...&radius=...
GET /api/geo/trending-supply?lat=...&lng=...&radius=...
====================================================================
3. BACKEND — СОБЫТИЯ ДЛЯ СБОРА СПРОСА
Регистрировать события:

search_query — пользователь ввёл «малина»,

empty_search — ничего не найдено,

category_open — открыл категорию,

ad_view,

favorite_add,

contact_click.

Формат:

ts
Копировать код
interface GeoEvent {
  userId?: ObjectId;
  lat: number;
  lng: number;
  createdAt: Date;
  type: 'search' | 'empty' | 'view' | 'favorite' | 'contact' | 'category';
  payload?: any;
}
Эти данные используются в Heatmap спроса.

====================================================================
4. MINIAPP — УМНАЯ КАРТА
Создать компонент:

/miniapp/src/geo-map/GeoMap.tsx

На основе:

Yandex Maps JS API или

Mapbox GL JS или

Leaflet (лёгкий вариант).

Основные элементы UI:

Карта на весь экран

пин пользователя

голубой пин KETMAR

тень/луч вокруг точки

анимация появления

Кнопка “Определить, где я”

круглое iOS-style

после нажатия:

карта центрируется,

отображается радиус.

Кольцо радиуса (внизу колесо-селектор)

0.3 км

1 км

3 км

5 км

10 км

20 км

Heatmap слой

Красно-жёлтый — спрос

Сине-зелёный — предложения

можно переключать.

Плавающая шторка (iOS slidesheet)

тянется вверх

снизу показываются объявления

реагирует на карту (если двигать карту → обновляется лента)

Плавающие подсказки (AI)
Примеры:

«В вашем районе ищут: выпечка, малина, картошка»

«Спрос на телефоны вырос на 18%»

«В Гершонах появилось 4 новых объявления по категории “Овощи”»

====================================================================
5. MINIAPP — ГЛАВНАЯ С КАРТОЙ
Главная теперь:

сверху поиск,

кнопка «Где я?»,

карта в превью режиме,

подсказка: «Выберите радиус — ↓ и потяните»,

разделы:

Популярное рядом

Сейчас ищут

Фермерский рынок

Сезонные ленты

====================================================================
6. ADMIN — ГЕО-АНАЛИТИКА
Создать раздел /admin/geo-dashboard:

Визуализационные блоки:

Heatmap спроса по городу

Heatmap предложений

Всплески спроса:

список запросов в последний час

всплески по районам

Всплески предложения:

новые товары по категориям

сезонная динамика

Тренды по районам:

«Гершоны — телефоны растут»

«Южный — много объявлений фруктов»

Карта с фильтрами:

категория

подкатегория

цена

спрос / предложение

====================================================================
7. ИНТЕГРАЦИЯ С AI-СЛОЕМ (MEGA-PROMPT 4.0)
Гео-карта должна использовать AI модели:

Модель классификации спроса:

«выпечка»

«малина»

«услуги»

«техника»

Модель аномалий:

слишком дешёвый товар → подсветить на карте

подозрительное объявление

всплеск мошенников в районе

Модель рекомендаций:

гео-рекомендации продавцу:

«В вашем районе ищут велосипед, подайте объявление»

гео-рекомендации покупателю:

«Появилась свежая выпечка в 600 метрах»

====================================================================
8. PUSH-УВЕДОМЛЕНИЯ ГЕОФОКУСА
Бот должен отправлять пуши:

Покупателю

«В радиусе 1.2 км появилось новое объявление по вашему запросу: малина»

«Цена на велосипед упала на 10% рядом с вами»

Продавцу

«В вашем районе ищут выпечку. Хотите подать объявление?»

Фермеру

«Спрос на клубнику вырос на 28% в Гершонах»

====================================================================
9. ОПТИМИЗАЦИЯ
Ввести:

GeoCache (10–30 сек),

throttling запросов карты,

cluster-подгрузку,

дебаунс движения карты.

====================================================================
10. ВЫПОЛНИТЬ:
Полный GeoEngine на backend

API для heatmap, спроса, предложений и трендов

Карта с heatmap в MiniApp

Селектор радиуса

Динамическая лента от карты

Подсказки: что ищут рядом

Push-уведомления покупатель/продавец

Geo-аналитика в admin

Интеграция AI

Ничего не ломать в текущем проекте

Всё строго на TypeScript

Красивый iOS-дизайн для карты