Ты — senior frontend-разработчик (React + TypeScript, Telegram MiniApp) в проекте KETMAR Market.

Нужно:

1) Привести в порядок **весь мастер подачи объявления** (from A to Z), чтобы:
   - у каждого шага была нормальная кнопка «Продолжить» / «Далее»,
   - шаг с фото был опциональным и не блокировал переход,
   - шаг с ценой/категорией тоже имел кнопку «Продолжить» и валидацию,
   - всё последовательно доходило до финального подтверждения/публикации.

2) Доработать **шаг с фото**:
   - мгновенный предпросмотр (без белых квадратов),
   - фоновая загрузка,
   - мультивыбор до 4 фото из галереи одним действием.

3) Обновить **гео-экран**:
   - пин и маркер пользователя в фирменных голубых цветах,
   - более современный дизайн пина,
   - на карте отчётливо видно, где находится пользователь (пин + круг радиуса).

Работай по шагам.

====================================================
0. ОБЩИЙ КОНТЕКСТ. СТРУКТУРА МАСТЕРА ПОДАЧИ ОБЪЯВЛЕНИЯ
====================================================

Мастер подачи объявления должен выглядеть так (по шагам):

1) **Шаг 1 — Локация**  
   - «Где вы продаёте?»  
   - Определяем геолокацию, показываем район/деревню/часть города.
   - Есть кнопка «Выбрать другое» (ручной выбор).

2) **Шаг 2 — Фото товара** (до 4 фото, НЕобязательно)  
   - 2×2 слота, добавление/удаление фото.
   - Можно пройти без фото.

3) **Шаг 3 — Детали объявления**  
   - Категория, подкатегория,
   - Цена (BYN, обязательна),
   - Описание (опционально).

4) **Шаг 4 — Контакты**  
   - Телефон/username/Instagram:
     - в первую очередь предлагается подтянуть из Telegram (номер/username),
     - если нет — даём подсказку, как поставить username, и поле для ввода номера + инстаграма.

5) **Шаг 5 — Подтверждение / Публикация**  
   - Краткий обзор объявления,
   - Кнопка «Опубликовать сейчас» (и опционально — «Запланировать»).

На всех шагах:

- сверху — прогрессбар / индикатор шагов, как уже есть,
- снизу — ОДНА большая кнопка «Продолжить» (или «Опубликовать» на последнем шаге) в фиксированном футере.

Сделай так, чтобы:

- у мастера была единая структура драфта (`draftAd`),
- каждый шаг читает/обновляет этот драфт и вызывает `onNext()` / `onBack()`.

Создай/проверь корневой компонент, что-то вроде:

```tsx
<AdCreateWizard>
  <StepLocation />
  <StepPhotos />
  <StepDetails />
  <StepContacts />
  <StepConfirm />
</AdCreateWizard>
====================================================

ШАГ 1 — ЛОКАЦИЯ + НОВЫЙ ПИН НА КАРТЕ
====================================================

Цель:

Определяем точку пользователя,

Показываем её на карте современным голубым пином в фирменных цветах,

Пользователь видит себя на карте + круг радиуса вокруг точки.

1.1. Стиль пина

Сделай пин не зелёным, а в наших цветах:

Основной цвет пина: насыщенный голубой #2B5CFF (или очень близкий),

Внутренняя точка — белая,

Обводка лёгкая, чтобы пин хорошо виден на белом и светло-сером фоне.

Форма:

классическая «капля» (drop pin),

слегка скруглённая, стиль «современный iOS/Яндекс»,

можно с небольшим shadow, чтобы отлипал от карты.

Для собственного рендеринга:

либо кастомная SVG-иконка,

либо иконка карт, но перекрашенная в наши цвета.

1.2. Показ точки пользователя на карте

На экране определения локации:

При успешном получении координат (lat, lng):

центрируй карту на этой точке,

отрисуй пин + полупрозрачный круг вокруг (например, 300–500 м) вторичным голубым цветом.

Цвет круга:

заливка "rgba(43, 92, 255, 0.12)",

обводка "rgba(43, 92, 255, 0.4)".

Если используем Leaflet / Yandex / Google:

создаём круг через соответствующий API.

1.3. Отображение района/деревни

Над картой:

показываем label: Ваше местоположение: <человекочитаемое имя>
(например, “Брест (Гершоны)”, “д. Пожежин”).

По-прежнему:

хранить точные координаты и GeoJSON у себя в БД,

пользователю показывать только обезличенный район/населённый пункт без улицы и дома.

1.4. Кнопка «Продолжить» на шаге локации

Внизу экрана, в общем футере:

tsx
Копировать код
<PrimaryButton fullWidth onClick={handleLocationNext}>
  Продолжить
</PrimaryButton>
handleLocationNext:

проверяет, что есть lat/lng и человекочитаемый район,

сохраняет их в draftAd,

вызывает onNext() (переход на шаг фото).

====================================================
2. ШАГ 2 — ФОТО ТОВАРА (ОПЦИОНАЛЬНО, НО УДОБНО)
Нужно решить сразу три задачи:

Мгновенный предпросмотр без белого квадрата.

Мультивыбор до 4 фото одним нажатием.

Нормальная кнопка «Продолжить», чтобы можно было идти дальше:

с 0 фото,

с 1–4 фото,

даже если загрузка идёт в фоне.

2.1. Модель состояния фото

Используй такую модель:

ts
Копировать код
type UploadStatus = 'idle' | 'uploading' | 'done' | 'error';

interface AdPhoto {
  id: string;
  localPreviewUrl: string; // URL.createObjectURL / dataURL
  file: File | null;
  uploadStatus: UploadStatus;
  remoteUrl?: string;      // URL файла на сервере, когда upload завершён
  isMain?: boolean;
}
State:

ts
Копировать код
const [photos, setPhotos] = useState<AdPhoto[]>([]);
2.2. Мгновенный предпросмотр

При выборе файлов:

сразу создаём localPreviewUrl для каждого файла через URL.createObjectURL(file),

добавляем их в photos,

сразу же отображаем превьюшки вместо пустых слотов (никакого белого экрана).

Рендер слотов (2×2):

если в позиции есть AdPhoto → показываем <img src={photo.localPreviewUrl}> + крестик удаления,

поверх — оверлей «загружается» / «ошибка» в зависимости от uploadStatus,

если в позиции нет photo → показываем пустой слот «Добавить» (иконка камеры + текст).

2.3. Мультивыбор до 4 фото

Сделай скрытый <input type="file" multiple accept="image/*">.

При клике на любой пустой слот или на кнопку «Добавить»:

открываем галерею (fileInputRef.current.click()),

пользователь может выбрать сразу 1–4 файла кружочками.

В обработчике:

учитываем уже существующие фото:

есть MAX_PHOTOS = 4,

считаем freeSlots = 4 - photos.length,

берём только первые freeSlots файла из выбранных.

2.4. Фоновая загрузка на сервер

После добавления AdPhoto в state:

запускаем startUpload(photo.id) для каждого нового:

startUpload:

выставляет uploadStatus: 'uploading',

запрашивает у backend uploadUrl + fileUrl,

отправляет файл на storage (PUT/POST),

по завершении:

uploadStatus: 'done',

remoteUrl = fileUrl,

при ошибке:

uploadStatus: 'error',

поверх превью кнопка «Повторить».

В процессе:

поверх миниатюры показать полупрозрачный голубой оверлей + маленький спиннер,
но само фото видно (никаких пустых прямоугольников).

2.5. Кнопка «Продолжить» на шаге фото

Футер:

tsx
Копировать код
<PrimaryButton fullWidth onClick={handlePhotosNext}>
  Продолжить
</PrimaryButton>
Логика:

Шаг фото опционален.

Переход на следующий шаг НИКОГДА не блокируй из-за статуса upload.

handlePhotosNext:

ts
Копировать код
const handlePhotosNext = () => {
  const uploaded = photos.filter(p => p.remoteUrl);

  onUpdateDraft({
    photos: uploaded.map(p => ({
      url: p.remoteUrl!,
      isMain: !!p.isMain,
    })),
  });

  onNext(); // всегда
};
То есть:

если фото нет → photos: [] или вообще это поле не отправляется — но шаг всё равно проходит;

если часть фото ещё грузится → сохраняем только те, что успели, остальные можно добавить потом через редактирование.

2.6. Удаление фото

При нажатии на крестик:

удаляем AdPhoto из массива,

вызываем URL.revokeObjectURL(photo.localPreviewUrl),

слоты сдвигаются, пустые квадраты уходят вниз.

====================================================
3. ШАГ 3 — ДЕТАЛИ: КАТЕГОРИЯ, ЦЕНА, ОПИСАНИЕ + КНОПКА «ПРОДОЛЖИТЬ»
Сейчас проблема: после заполнения категории/цены/описания нет кнопки "Далее" — пользователь застревает.

Нужно:

чёткая кнопка «Продолжить» внизу,

простая валидация обязательных полей.

3.1. Обязательные поля

Считаем обязательными:

categoryId (категория),

subcategoryId (подкатегория),

price (> 0).

Описание — опционально.

3.2. Валидация

В компоненте шага:

ts
Копировать код
const [errors, setErrors] = useState<{ category?: string; subcategory?: string; price?: string }>({});
validate():

если нет categoryId → errors.category = 'Выберите категорию',

если нет subcategoryId → errors.subcategory = 'Выберите подкатегорию',

если price <= 0 или пусто → errors.price = 'Укажите цену'.

Под каждым полем с ошибкой показываем маленький красный текст.

3.3. Кнопка «Продолжить»

Футер:

tsx
Копировать код
<PrimaryButton fullWidth onClick={handleDetailsNext}>
  Продолжить
</PrimaryButton>
handleDetailsNext:

ts
Копировать код
const handleDetailsNext = () => {
  if (!validate()) return;

  onUpdateDraft({
    categoryId: values.categoryId,
    subcategoryId: values.subcategoryId,
    price: Number(values.price),
    description: values.description ?? '',
  });

  onNext();
};
Обязательно убедись, что:

при возврате на шаг значения подтягиваются из draftAd,

кнопка видно на любых устройствах (используй position: sticky футера, чтобы клавиатура не закрывала).

====================================================
4. ШАГИ 4–5 — КОНТАКТЫ И ФИНАЛЬНОЕ ПОДТВЕРЖДЕНИЕ
4.1. Шаг контактов

Цель: максимально упростить жизнь пользователю.

Первым делом:

пытаемся подтянуть телефон и/или username из Telegram (если они доступны из контекста MiniApp),

показываем их в полях как заполненные.

Если username нет:

показываем небольшую подсказку:

как включить username в настройках Telegram,

даём поле для ввода телефона вручную.

Опциональное поле: Instagram (строка).

Кнопка внизу: «Продолжить».

При клике:

сохраняем контакты в draftAd,

onNext().

4.2. Финальный шаг — публикация

Отображаем краткий обзор объявления:

заголовок,

цена,

район,

1–4 фото (или заглушка «Фото не добавлены»),

контакты.

Кнопка: «Опубликовать».

Опционально — вторая кнопка «Запланировать» (если у нас уже реализована отложенная публикация).

При нажатии «Опубликовать»:

отправляем draftAd на backend,

блокируем кнопку/показываем спиннер до ответа,

при успехе:

показываем экран «Объявление отправлено на модерацию» / «Опубликовано»,

даём кнопку перейти к Мои объявления.

====================================================
5. ОБЩИЕ ТРЕБОВАНИЯ К ФУТЕРУ (КНОПКЕ "ПРОДОЛЖИТЬ")
На каждом шаге мастера (кроме, возможно, самого последнего) должен быть единый футер:

tsx
Копировать код
<div className="wizard-footer">
  <PrimaryButton fullWidth onClick={handleNext}>
    {isLastStep ? 'Опубликовать' : 'Продолжить'}
  </PrimaryButton>
</div>
CSS (пример):

css
Копировать код
.wizard-footer {
  position: sticky;
  bottom: 0;
  background: #ffffff;
  padding: 12px 16px calc(env(safe-area-inset-bottom, 0px) + 12px);
  box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.04);
}
Важно:

Кнопка должна быть всегда доступна:

после выбора/отказа от фото,

после ввода цены/описания,

на контактах,

на финальном шаге.

Никаких ситуаций, когда пользователь заполнил поля и не видит способа идти дальше.

====================================================
6. ЧТО ПРОВЕРИТЬ ПОСЛЕ ВНЕСЕНИЯ ИЗМЕНЕНИЙ
Прогоняем такие сценарии:

Без фото:

выбрал локацию → нажал «Продолжить» →

пропустил фото → «Продолжить» →

заполнил категорию/цену/описание → «Продолжить» →

контакты → «Продолжить» →

«Опубликовать» → объявление создано.

С одним фото:

выбрал одно фото → сразу виден предпросмотр,

поверх виден индикатор загрузки, пока летит на сервер,

кнопка «Продолжить» работает, не ждёт 1 минуту.

С четырьмя фото из галереи:

нажал один слот → выбрал 4 фото кружочками →

все 4 встали в сетку 2×2,

каждое с превью и отдельным крестиком удаления.

Гео-экран:

пин голубой, современный,

вокруг — полупрозрачный круг/ореол,

карта центрируется на пользователе,

label «Ваше местоположение: …» показывает район/деревню, а не точный адрес.

Кнопки:

на каждом шаге есть «Продолжить»,

нигде не остаётся ситуации «всё заполнил, а кнопки дальше нет».

В конце выведи:

список изменённых/созданных файлов (по фронту и miniapp),

кратко, что в каждом сделано (мастер, шаги, футер, гео-пин, фото-шаг)