–®–∞–≥ 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (callback_query)

–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–∂–∞—Ç–∏—è –ø–æ –∫–Ω–æ–ø–∫–∞–º –≤–∏–¥–∞ sell_cat:<slug> –∏ –≤—ã–≤–µ—Å—Ç–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏.

–°—Ä–∞–∑—É –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /sell (–∏ –¥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ bot.on("text", ...)) –≤—Å—Ç–∞–≤—å:

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (callback sell_cat:<slug>)
  bot.action(/sell_cat:(.+)/, async (ctx) => {
    try {
      const API_BASE_URL = process.env.API_BASE_URL || "http://localhost:3000";
      const slug = ctx.match[1];

      // —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º—ã –≤ —Ä–µ–∂–∏–º–µ sell
      if (!ctx.session || !ctx.session.sell) {
        return ctx.answerCbQuery("–î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω. –í–≤–µ–¥–∏ /sell.");
      }

      ctx.session.sell.data.categoryId = slug;

      // –∑–∞–±–∏—Ä–∞–µ–º –¥–µ—Ä–µ–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
      const res = await axios.get(`${API_BASE_URL}/api/categories`);
      const categories = res.data || [];

      // –Ω–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–æ—Ä–Ω–µ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
      const rootCat = categories.find((c) => c.slug === slug);
      if (!rootCat) {
        return ctx.answerCbQuery("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
      }

      const subcats = rootCat.subcategories || [];
      if (!subcats.length) {
        // –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∑–∞–≥–æ–ª–æ–≤–∫—É
        ctx.session.sell.data.subcategoryId = null;
        ctx.session.sell.step = "title";

        await ctx.editMessageText(
          `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${rootCat.name}\n\n` +
          "–®–∞–≥ 2/5 ‚Äî –≤–≤–µ–¥–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–°–≤–µ–∂–∞—è –º–∞–ª–∏–Ω–∞¬ª)."
        );
        return;
      }

      // –µ—Å—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
      ctx.session.sell.step = "choose_subcategory";

      const keyboard = subcats.map((sub) => [
        {
          text: sub.name,
          callback_data: `sell_subcat:${sub.slug}`,
        },
      ]);

      await ctx.editMessageText(
        `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${rootCat.name}\n\n` +
        "üß© –®–∞–≥ 2/5 ‚Äî –≤—ã–±–µ—Ä–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        {
          reply_markup: {
            inline_keyboard: keyboard,
          },
        }
      );
    } catch (err) {
      console.error("sell_cat error:", err.response?.data || err.message);
      ctx.reply("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ /sell.");
    }
  });


–°–æ—Ö—Ä–∞–Ω–∏.