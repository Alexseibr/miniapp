✅ ПРОМПТ №1 — Аналитика карточки товара (показы, просмотры, контакт-клики)

Скопируй в Replit / Codex:

PROMPT: “Сделать аналитику карточки товара + поправить поиск и подкатегории”

Хочу, чтобы ты дописал функционал аналитики и логику поиска на MiniApp KETMAR Market.

1. Добавить аналитику карточки товара

Для каждой карточки объявления (Ad) нужно собрать аналитику:

1.1. Поля в MongoDB (в коллекции Ads)

Добавить:

viewsTotal: Number       // сколько раз открыли карточку
viewsToday: Number       // за сегодня
impressionsTotal: Number // сколько раз показалось в ленте
contactClicks: Number    // сколько раз нажали "Показать телефон / username"
firstShownAt: Date       // первый показ в ленте
lastShownAt: Date        // последний показ в ленте

1.2. Инкременты

Когда карточка появляется в ленте → impressionsTotal++

Когда пользователь открывает → viewsTotal++

Когда нажимают на контакт → contactClicks++

1.3. API (backend)

Создать эндпоинты:

POST /api/ads/:id/track-impression
POST /api/ads/:id/track-view
POST /api/ads/:id/track-contact


Без авторизации (но с защитой min-rate-limit).

1.4. Frontend (React / MiniApp)

Вызывать:

track-impression — при первом появлении объявления в viewport

track-view — при переходе в карточку

track-contact — при клике на “Показать номер / username / Instagram”

2. Исправить поведение категорий на главной странице

Сейчас по нажатию на категорию ставится галочка, а должно:

✔ переходить в подкатегории (второй уровень), а не выделять чекбокс
✔ галочка вообще не нужна
✔ каждая карточка категории кликабельная и ведёт на отдельную страницу со списком подкатегорий

3. Исправить поиск на главной странице

Требуется логика:

3.1. Как должно работать

Пользователь вводит слово в строку поиска → нажимает Enter → происходит:

Открывается вкладка Лента.

Выполняется определение геопозиции (если ещё не определена).

Выполняется GET запрос:

GET /api/ads/search?q=малина&lat=...&lng=...


Искать:

в названии

в описании

в ключевых словах

в комментариях, если есть

Выводить результаты в радиусе 3 км по умолчанию.

3.2. API

Сделать новый эндпоинт:

GET /api/ads/search?q=&lat=&lng=&radiusKm=

4. Баг: изображения в категориях

На главной странице картинки категорий сломаны (квадратные, смещённые).
Нужно:

✔ вернуть прежнее оформление (скругления, тени, адаптивный размер)
✔ исправить пропорции изображения
✔ сделать все 3D иконки одинаковыми по размеру

5. Вложения

Вот локальный путь к скриншоту с ошибкой (чтобы видеть проблему):

/mnt/data/772ecbc3-5a18-44d4-9cd5-ca1253550e66.jpeg


Используй его как референс для фикса UI.

✅ ПРОМПТ №2 — Отдельно только под аналитику (если нужен чистый вариант)
PROMPT: “Добавить аналитику показа и просмотров карточек”

Добавить в каждую карточку Ads статистику:

impressionsTotal — счётчик показов в ленте

impressionsToday

viewsTotal — сколько раз открыли карточку

firstShownAt, lastShownAt

contactClicks — сколько раз нажали “Показать телефон / username / Instagram”

Добавить API:

POST /api/ads/:id/track-impression
POST /api/ads/:id/track-view
POST /api/ads/:id/track-contact


UI-требование:

Вызвать track-impression при появлении карточки в viewport (IntersectionObserver).

Вызвать track-view при переходе внутрь карточки.

Вызвать track-contact при нажатии на контакт.