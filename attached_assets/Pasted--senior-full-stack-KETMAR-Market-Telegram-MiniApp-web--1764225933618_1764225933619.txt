Ты — senior full-stack разработчик KETMAR Market (гео-маркетплейс в Telegram MiniApp + web).

Нужно реализовать:

1) Полную аналитику маркетинговых кампаний (ярмарок):  
   - 8 марта тюльпаны (`march8_tulips`)  
   - новогодняя ярмарка (`newyear_fair`)  
   - в будущем любые `campaignCode`  
2) Витрины кампаний и витрины магазинов с фильтрами:  
   - «Тюльпаны 8 марта»,  
   - «Новогодние подарки / ярмарка»,  
   - сезонные подборки,  
   - только товары кампании у конкретного магазина.

При этом:

- тюльпаны и новогодняя ярмарка относятся к **магазинам** (store),
- осенняя ярмарка остаётся фермерской (farmer),
- все остальные круглогодичные ярмарки считаем «магазинными» по умолчанию.

---

## 0. Базовый контекст и модели

У нас уже есть:

- `User`
- `Store` (магазин) — кабинет магазина
- `Ad` — объявление
- `AdEvent` — события (просмотр / клик по контакту / избранное и т.д.) — если нет, создай (см. ниже)

Нужно добавить:

### 0.1. Модель кампаний

Создай модель `Campaign` (Mongoose):

- `code: string` — уникальный код, например:
  - `"march8_tulips"`
  - `"newyear_fair"`
  - `"autumn_fair"`
  - `"summer_sale"`
- `title: string` — человекочитаемое название
- `description?: string`
- `type: "store" | "farmer"` — кому относится (магазины или фермеры)
- `startDate?: Date`
- `endDate?: Date`
- `isActive: boolean`
- `createdAt: Date`
- `updatedAt: Date`

Инициализируй (миграцией / сидом) минимум:

1) `march8_tulips` — `type = "store"`
2) `newyear_fair` — `type = "store"`
3) `autumn_fair` — `type = "farmer"`

### 0.2. Поле кампании в объявлениях

В `Ad` добавить:

- `campaignCode?: string` — ссылка на кампанию (по `code`)
- `storeId?: ObjectId` — магазин (для кампаний `type="store"` обязателен)
- `isFarmerAd?: boolean` — для фермеров (опционально, если ещё нет)

Требование:

- для объявлений с `campaignCode="march8_tulips"` или `"newyear_fair"`:
  - **обязательно** должно быть `storeId` (магазин),
  - фермерские без магазина сюда не попадают.

---

## 1. AdEvent (если нет — создать / доработать)

Модель `AdEvent`:

- `adId: ObjectId`
- `storeId?: ObjectId`
- `campaignCode?: string`
- `userId?: ObjectId`
- `type: "view" | "favorite" | "contact_click" | "open_telegram" | "call_click" | "share" | "open_store" | "open_campaign"`
- `source: "organic" | "campaign" | "boost" | "banner" | "push"`
- `createdAt: Date`
- `geo?: { type: "Point", coordinates: [lng, lat] }`
- `categoryId?: ObjectId`
- `priceAtMoment?: number` — цена на момент события (для ценовой аналитики позже)

Индексы:

- `{ campaignCode: 1, createdAt: 1 }`
- `{ storeId: 1, createdAt: 1 }`
- `{ adId: 1, createdAt: 1 }`
- при наличии гео — 2dsphere по `geo`.

Фронт должен уже уметь слать события (если нет — добавить):

- при просмотре карточки объявления: `type="view"`, `source` = `"campaign"` если находимся в кампании.
- при клике по телефону: `type="contact_click"`
- при клике «написать в Telegram»: `type="open_telegram"`
- при входе в витрину кампании: `type="open_campaign"` с `campaignCode`.

---

## 2. Аналитика кампаний (march8 / newyear / любые)

Создать router `/api/campaign-analytics` (только для админки + кабинета магазина, где владелец видит свои кампании).

### 2.1. Обзор кампании

`GET /api/campaign-analytics/overview?campaignCode=march8_tulips&period=7d|30d`

Возвращает:

- `campaign` — данные кампании (`title`, `startDate`, `endDate`, `type`)
- Период (`periodStart`, `periodEnd`)
- Общие метрики за период:
  - `totalViews`
  - `totalContactClicks`
  - `totalFavorites`
  - `totalShares`
  - `ctrContacts` = contactClicks/views
- Разрез по каналам source:
  - `{ source: "organic" | "push" | "banner" | ..., views, contactClicks }`
- ТОП магазинов в кампании:
  - `topStoresByViews` — 5 магазинов: `storeId, name, views, contactClicks`
  - `topStoresByContactClicks`
- ТОП объявлений:
  - `topAdsByViews` — 5 объявлений: `adId, title, storeName, views, contactClicks, favorites`

Выборка:

- только события `AdEvent`, где:
  - `campaignCode = ?`
  - `createdAt` в периоде.

### 2.2. Гистограмма по дням внутри кампании

`GET /api/campaign-analytics/daily?campaignCode=march8_tulips&metric=views|contactClicks|favorites&period=30d`

Ответ:

- массив:
  - `{ date: "YYYY-MM-DD", value: number }`
- `totalValue`

Использовать `AdEvent` + `$group` по дате.

ВАЖНО: Это будет использоваться для кликабельной гистограммы в админке / в PRO-кабинете.

### 2.3. География спроса кампании

`GET /api/campaign-analytics/geo?campaignCode=march8_tulips&period=30d`

Ответ:

- список агрегатов по `city` / `region` / `lat-lng` (упрощённо):

Вариант 1 (по городам/районам):

- `{ city, region, views, contactClicks }`

Вариант 2 (heatmap):

- `{ lat, lng, weight: number }`  
  где `weight` = нормализованная метрика по просмотрам/кликам.

Пока достаточно уровня город/район, но код для гео-heatmap тоже подготовь (через `geo` в `AdEvent`).

### 2.4. Аналитика цен кампании (тюльпаны / Новый год)

`GET /api/campaign-analytics/prices?campaignCode=march8_tulips&period=7d`

Ответ:

- `avgPrice` по кампании
- `minPrice`, `maxPrice`
- `adsCount`
- разрез по городу/району:

  - массив `{ city, avgPrice, adsCount }`

`priceAtMoment` можно брать:

- либо из `AdEvent`,
- либо напрямую из `Ad` (актуальная цена), если считать на текущий момент.

Эта аналитика нужна, чтобы:

- видеть среднюю цену на тюльпаны по городу,
- сравнивать магазины,
- показывать продавцам, сколько они ниже/выше рынка.

---

## 3. Витрина кампаний (общая и для магазина)

### 3.1. Публичная витрина кампании (глобальная)

Новое API:

`GET /api/campaigns/:campaignCode/ads?lat=&lng=&radiusKm=&sort=distance|price|popular&page=&limit=`

Фильтры:

- `campaignCode` обязателен (march8_tulips / newyear_fair / etc.)
- опционально:
  - `lat, lng, radiusKm` — если заданы, используем геопоиск, сортируем по расстоянию;
  - если не заданы — просто сортируем по популярности.

Ответ:

- `ads: [ { adId, title, price, mainPhotoUrl, storeName, distanceKm?, city, badges[] } ]`
- `total`
- `page`
- `hasMore`

Бейджи:

- для тюльпанов:
  - `["букет", "по штучно", "нижe рынка на X%"]`
- для новогодних:
  - `["подарочный набор", "детям", "свечи", "ёлка"]` и т.п. (можно примитивно по словам).

На фронте (MiniApp):

- Страница «Ярмарка 8 марта» и «Новогодняя ярмарка»:
  - сверху заголовок + описание,
  - селектор: `рядом со мной` / `по городу`,
  - селектор сортировки: `по расстоянию`, `дешевле`, `популярнее`,
  - сетка карточек (2 в ряд или 1 в ряд, в зависимости от текущего UI).

### 3.2. Витрина магазина для кампании

Новое API:

`GET /api/store/:storeSlug/campaign/:campaignCode/ads?page=&limit=&sort=...`

Возвращает объявления **конкретного магазина** внутри кампании.

На фронте:

- В публичной витрине магазина (микросайт магазинов, если уже есть или нужно сделать):

  - добавить вкладки:
    - «Все товары»
    - «Тюльпаны 8 марта» (если у магазина есть такие объявления)
    - «Новогодняя ярмарка» (если есть)

Логика:

- вкладку кампании показывать только если у магазина есть объявления с данным `campaignCode`.

---

## 4. Кнопки/флоу подачи товаров в кампанию

При создании / редактировании объявления в кабинете магазина:

- если текущий период попадает в активный период кампаний (`march8_tulips`, `newyear_fair`):
  - показать блок:

    > «Сейчас идёт кампания:  
    > [Тюльпаны 8 марта] [Новогодняя ярмарка]  
    > Отметьте, если это товар для кампании.»

  - чекбоксы:
    - «Отнести к тюльпанам 8 марта»
    - «Отнести к новогодней ярмарке»

При выборе чекбокса:

- в запросе создания/обновления объявления указывать:
  - `campaignCode = "march8_tulips"` или `"newyear_fair"`.

---

## 5. PRO-аналитика кампаний для магазина

В кабинете магазина (Store PRO):

Добавить блок отдельно от общей аналитики магазина:

### 5.1. Список кампаний магазина

`GET /api/store/me/campaigns`

- возвращает список кампаний, в которых магазин участвует (есть объявления с `storeId` и `campaignCode`):
  - `campaignCode`, `title`, `isActive`, `adsCount`, `views`, `contactClicks`.

На фронте:

- Вкладка «Кампании» внутри PRO-аналитики магазина.
- По каждой кампании:
  - название,
  - период,
  - `Товаров: N`,
  - `Просмотры / Клики по контактам`.

### 5.2. Детальная аналитика кампании для конкретного магазина

`GET /api/store/me/campaigns/:campaignCode/analytics?period=7d|30d`

Это уже не глобальная аналитика (по всем магазинам), а **только для текущего магазина**:

Вернуть:

- `totalViews`, `totalContactClicks`, `totalFavorites`
- `topAds` магазина в рамках этой кампании
- `daily` гистограмма (как выше, но с фильтром по `storeId`)

Фронт:

- внутри вкладки «Кампании» → по клику на кампанию открываем её аналитический экран:
  - обзор,
  - гистограмма,
  - таблица товаров.

---

## 6. Ограниченная логика по фермерскому кабинету

Важно:

- **Осенняя ярмарка (`autumn_fair`)** остаётся фермерской:
  - `type = "farmer"`
  - объявления, где `campaignCode="autumn_fair"` и `isFarmerAd=true`
  - анализируются и показываются только в фермерском кабинете, отдельной логикой (можно использовать тот же `/api/campaign-analytics`, но с фильтром `type="farmer"`).

- Все остальные (`march8_tulips`, `newyear_fair`, другие круглогодичные кампании) — относятся к `type="store"`:
  - попадают в магазинный PRO-кабинет.

Убедись:

- что в query/фильтрах по кампании всегда учитывается `type`, чтобы фермерский и магазинный интерфейсы не конфликтовали.

---

## 7. Технические требования

- Backend: TypeScript + Express + Mongoose, бизнес-логика отдельно от роутеров.
- Продумать пагинацию и лимиты (по умолчанию `limit=20`).
- Везде проверять права:
  - глобальная аналитика кампаний — только для админки;
  - магазинная аналитика кампаний — только для владельца магазина.
- Фронт (MiniApp):
  - UI не ломать, адаптировать к текущему стилю: табы / карточки / гистограммы.
  - Для гистограмм можно отдать только данные — отрисовку сделает фронт через существующую либу.

Цель:
- Сделать единую, аккуратную систему **кампаний (ярмарок)**:
  - глобальная витрина по кампании (8 марта / Новый год),
  - витрина кампании в магазине,
  - полная аналитика кампаний (просмотры, клики, гео, цены),
  - магазинный PRO-кабинет с вкладкой «Кампании»,
  - корректное разделение: магазинные кампании vs фермерские (осенняя ярмарка).
