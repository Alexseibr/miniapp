# Гео-лента как в Яндекс Go

Цель — мгновенная выдача только вокруг пользователя, без перегруза бэкенда и сети. Подходит для упаковки в промпт/ТЗ.

## 1. Модель данных и индексы
- У объявления сохраняем координаты, логическую зону и компактную клетку:
  - `location: { lat, lng, geo: { type: 'Point', coordinates: [lng, lat] } }`
  - `geoZoneId: string` (город/район/кластер)
  - `geoHash: string` (любой грид-код)
- В MongoDB:
  - 2dsphere индекс по `location.geo`
  - обычные индексы по `geoZoneId` и `geoHash`
- Любая выдача: **сначала фильтр по зоне, потом по радиусу**.

## 2. Backend-алгоритм `/ads/near`
Запрос: `GET /ads/near?lat=..&lng=..&radius=..&geoZoneId=..&limit=..&cursor=..`

1. Определяем `geoZoneId` по координатам (таблица/полигоны).
2. Запрос к Mongo:
   - фильтр `geoZoneId = текущий`
   - `$geoNear` с `maxDistance = radius`
   - `limit = 20–30`, projection только лёгких полей (`id`, `title`, `price`, `thumb`, `distance`, `sellerType`).
3. Пагинация через cursor (`createdAt`/`_id`), не `skip/offset`.
4. Endpoint требует `geoZoneId`; без него — ошибка или минимальный радиус.

## 3. Ступени радиуса
Фиксированные шаги: 300 → 700 → 1500 → 3000 м (максимум).

- Первый запуск: 300 м; если мало объявлений — автоматически расширяем до 700 м.
- В UI кнопка «Расширить зону поиска» двигает к следующему шагу и делает запрос.
- Радиус жёстко ограничен 3 км, чтобы не тянуть пол-области.

## 4. Фронт-логика
### 4.1. Кеш в сторе
```ts
cache[geoZoneId][radiusStep] = {
  ads: AdPreview[],
  lastUpdated: number,
}
```
Правила:
- Остаёмся в зоне и радиус не уменьшился → показываем кеш сразу, в фоне обновляем.
- Радиус увеличен → делаем запрос и объединяем старые + новые объявления по `id`.
- Зона изменилась → новый ключ кеша, старая выдача не используется.

### 4.2. Debounce по гео
- Смещение центра <100–150 м → не обновляем.
- Смещение >150 м → debounce 400–600 мс, один запрос после остановки движения.

### 4.3. Ленивая загрузка
- Первая страница 20 объявлений; ниже — infinite scroll по `cursor`.
- Никогда не грузим сразу 200+.

## 5. Защита от «левых» объявлений
- Бизнес-ограничение: показываем только `geoZoneId` пользователя (или соседние по необходимости).
- Гео-ограничение: `$geoNear maxDistance` не вернёт удалённые объекты.

## 6. Размещение объявления
- Форма создания использует уже полученные `location` и `geoZoneId`, без повторных запросов.
- Сохраняем `location + geoZoneId`; тяжёлые задачи (модерация, AI, ресайз) уводим в job queue (BullMQ/RabbitMQ).

## 7. Redis-кеш горячих зон (опционально)
- Ключ: `f:ads:zone:{geoZoneId}:radius:{step}:page:{n}`, TTL 10–120 секунд.
- Популярные зоны обслуживаются из кеша, база не трогается.

## 8. Формат промпта
В промпт можно включить:
- Контракт `/ads/near` с обязательным `geoZoneId`, фильтр по зоне + `$geoNear`.
- Радиусные ступени 300/700/1500/3000 и кнопка «Расширить».
- Клиентский кеш по `(geoZoneId, radiusStep)`, объединение страниц без дублей.
- Debounce по гео, лимиты на смещение, ленивую загрузку.
- Отложенные фоновые задачи при создании объявления.
