# ‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ì–û–¢–û–í!

## üìã –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (90% –∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π)

### 1Ô∏è‚É£ **–ú–æ–¥–µ–ª—å Ad —Ä–∞—Å—à–∏—Ä–µ–Ω–∞** ‚úÖ
–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `city` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞:
```javascript
// models/Ad.js
city: {
  type: String,
  trim: true,
  default: null,
},
```

### 2Ô∏è‚É£ **Helper –¥–ª—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è** ‚úÖ
–§—É–Ω–∫—Ü–∏—è `haversineDistanceKm` —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞:
```javascript
// utils/distance.js
export function haversineDistanceKm(pointA, pointB)
```

### 3Ô∏è‚É£ **API Endpoints —Å –≥–µ–æ–ø–æ–∏—Å–∫–æ–º** ‚úÖ

#### **GET /api/ads/search**
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `lat` ‚Äî —à–∏—Ä–æ—Ç–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
- `lng` ‚Äî –¥–æ–ª–≥–æ—Ç–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
- `maxDistanceKm` ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞
- `categoryId`, `subcategoryId` ‚Äî —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

```bash
# –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞
curl "http://localhost:5000/api/ads/search?lat=53.9&lng=27.5&categoryId=realty&maxDistanceKm=50"
```

#### **GET /api/ads/nearby** ‚úÖ
–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π endpoint –¥–ª—è –ø–æ–∏—Å–∫–∞ "—Ä—è–¥–æ–º —Å–æ –º–Ω–æ–π":
```bash
# –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞
curl "http://localhost:5000/api/ads/nearby?lat=53.9&lng=27.5&maxDistanceKm=10"
```

#### **GET /api/ads/live-spots** ‚úÖ
–ü–æ–∏—Å–∫ "–∂–∏–≤—ã—Ö —Ç–æ—á–µ–∫" (isLiveSpot=true) —Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–µ–π:
```bash
# –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞
curl "http://localhost:5000/api/ads/live-spots?lat=53.9&lng=27.5&radiusKm=20"
```

---

## üìÑ –ü—Ä–∏–º–µ—Ä—ã JSON –æ—Ç–≤–µ—Ç–æ–≤

### ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (POST /api/ads)
```json
{
  "_id": "692377f19f01bd81e74df09e",
  "title": "–ö–≤–∞—Ä—Ç–∏—Ä–∞ 2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –≤ —Ü–µ–Ω—Ç—Ä–µ",
  "description": "–û—Ç–ª–∏—á–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ —Å —Ä–µ–º–æ–Ω—Ç–æ–º",
  "categoryId": "realty",
  "subcategoryId": "realty_rent_long",
  "price": 800,
  "currency": "BYN",
  "city": "–ú–∏–Ω—Å–∫",
  "sellerTelegramId": 999888777,
  "location": {
    "lat": 53.9006,
    "lng": 27.559,
    "geo": {
      "type": "Point",
      "coordinates": [27.559, 53.9006]
    }
  },
  "status": "active",
  "moderationStatus": "pending",
  "lifetimeDays": 7,
  "validUntil": "2025-11-30T21:08:47.123Z",
  "views": 0,
  "createdAt": "2025-11-23T21:08:47.126Z"
}
```

### ‚úÖ –ü–æ–∏—Å–∫ —Å —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ–º (GET /api/ads/search?lat=53.8&lng=27.5)
```json
{
  "items": [
    {
      "_id": "692377f19f01bd81e74df09e",
      "title": "–ö–≤–∞—Ä—Ç–∏—Ä–∞ 2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –≤ —Ü–µ–Ω—Ç—Ä–µ",
      "price": 800,
      "currency": "BYN",
      "city": "–ú–∏–Ω—Å–∫",
      "categoryId": "realty",
      "subcategoryId": "realty_rent_long",
      "distanceKm": 11.2,
      "distanceMeters": 11234,
      "location": {
        "lat": 53.9006,
        "lng": 27.559
      },
      "photos": [],
      "status": "active"
    }
  ],
  "total": 1,
  "hasMore": false
}
```

---

## üéØ –§–æ—Ä–º–∞—Ç –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

–î–ª—è UI –≤–∏–¥–∞ **"–ú–∏–Ω—Å–∫ ‚Ä¢ 850 –º –æ—Ç –≤–∞—Å"** –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:

```javascript
// JavaScript –ø—Ä–∏–º–µ—Ä
function formatDistance(ad) {
  if (!ad.city && !ad.distanceKm) return '';
  
  const cityPart = ad.city || '';
  const distancePart = ad.distanceKm 
    ? (ad.distanceKm < 1 
        ? `${(ad.distanceKm * 1000).toFixed(0)} –º –æ—Ç –≤–∞—Å`
        : `${ad.distanceKm.toFixed(1)} –∫–º –æ—Ç –≤–∞—Å`)
    : '';
  
  return [cityPart, distancePart].filter(Boolean).join(' ‚Ä¢ ');
}

// –ü—Ä–∏–º–µ—Ä—ã –≤—ã–≤–æ–¥–∞:
// "–ú–∏–Ω—Å–∫ ‚Ä¢ 850 –º –æ—Ç –≤–∞—Å"
// "–ë—Ä–µ—Å—Ç ‚Ä¢ 12.3 –∫–º –æ—Ç –≤–∞—Å"  
// "–ú–∏–Ω—Å–∫" (–µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è)
```

---

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ MiniApp

### TypeScript —Ç–∏–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã ‚úÖ
```typescript
// miniapp/src/types/index.ts
export interface AdPreview {
  _id: string;
  title: string;
  city?: string | null;
  distanceKm?: number;
  // ...
}

export interface CreateAdPayload {
  title: string;
  categoryId: string;
  subcategoryId: string;
  price: number;
  city?: string;
  location?: {
    lat: number;
    lng: number;
    geo?: {
      type: 'Point';
      coordinates: [number, number];
    };
  };
  // ...
}
```

### –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ ‚úÖ
–í `CreateAdPage.tsx` –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ "–ì–æ—Ä–æ–¥":
```tsx
<input
  type="text"
  value={city}
  onChange={(e) => setCity(e.target.value)}
  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∏–Ω—Å–∫"
/>
```

---

## ü§ñ –û–¥–∏–Ω –æ–±—â–∏–π –±–æ—Ç –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–æ–¥–∏–Ω –±–æ—Ç** –¥–ª—è –≤—Å–µ—Ö –Ω–∏—à:
- –§–µ—Ä–º–µ—Ä—ã ‚Üí `categoryId=farm`
- –†–µ–º–µ—Å–ª–µ–Ω–Ω–∏–∫–∏ ‚Üí `categoryId=craft`
- –ê—Ä–µ–Ω–¥–∞ ‚Üí `categoryId=realty`
- –Ø—Ä–º–∞—Ä–∫–∏ ‚Üí `seasonCode=spring_fair`

–ù–∏—à–µ–≤–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è:
1. **–ö–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏** (`Category.slug`)
2. **–°–µ–∑–æ–Ω–∞–º–∏** (`seasonCode`)
3. **Deep links** –≤ MiniApp

---

## üìä –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|-----------|--------|
| ‚úÖ –ü–æ–ª–µ `city` –≤ –º–æ–¥–µ–ª–∏ Ad | **–ì–û–¢–û–í–û** |
| ‚úÖ Helper haversineDistanceKm | **–ì–û–¢–û–í–û** |
| ‚úÖ GET /api/ads/search —Å lat/lng | **–ì–û–¢–û–í–û** |
| ‚úÖ GET /api/ads/nearby | **–ì–û–¢–û–í–û** |
| ‚úÖ –í–æ–∑–≤—Ä–∞—Ç city + distanceKm | **–ì–û–¢–û–í–û** |
| ‚úÖ MiniApp —Ñ–æ—Ä–º–∞ —Å city | **–ì–û–¢–û–í–û** |
| ‚úÖ TypeScript —Ç–∏–ø—ã | **–ì–û–¢–û–í–û** |
| ‚úÖ Middleware –≤–∞–ª–∏–¥–∞—Ü–∏—è | **–ì–û–¢–û–í–û** |

---

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã. –ì–µ–æ–ª–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω:

1. ‚úÖ –•—Ä–∞–Ω–∏—Ç—Å—è –≥–æ—Ä–æ–¥ –ø—Ä–æ–¥–∞–≤—Ü–∞
2. ‚úÖ –°—á–∏—Ç–∞–µ—Ç—Å—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
3. ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `city` –∏ `distanceKm` –≤ API
4. ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Ä–∞–¥–∏—É—Å—É
5. ‚úÖ –û–¥–∏–Ω –æ–±—â–∏–π –±–æ—Ç –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
6. ‚úÖ –§–æ—Ä–º–∞—Ç –¥–ª—è UI "–ú–∏–Ω—Å–∫ ‚Ä¢ 850 –º –æ—Ç –≤–∞—Å"
